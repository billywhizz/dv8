let ENV=global.env().map(e=>e.split('=')).reduce((e,n)=>{e[n[0]]=n[1];return e},{});if(ENV.DV8_MODULES){let e=global.library;global.library=(n,t)=>e(n,t,ENV.DV8_MODULES)}let{Process}=library('process',{}),{Timer}=library('timer',{}),{Thread}=library('thread',{}),{EventLoop}=library('loop',{}),{Socket,UNIX}=library('socket',{}),{File,O_RDONLY}=library('fs',{}),{UV_TTY_MODE_NORMAL,TTY}=library('tty',{});function pathModule(){let e=47,n=92,t=46;function r(e){return e.slice(0,e.lastIndexOf('/')+1)}function a(t){return t===e||t===n}function s(n){return n===e}function i(n,r,s){let i='',o=0,l=-1,c=0,u=0;for(let g=0;g<=n.length;++g){if(g<n.length)u=n.charCodeAt(g);else if(a(u)){break}else u=e;if(a(u)){if(!(l===g-1||c===1))if(c===2){if(i.length<2||o!==2||i.charCodeAt(i.length-1)!==t||i.charCodeAt(i.length-2)!==t){if(i.length>2){let e=i.lastIndexOf(s);e===-1?(i='',o=0):(i=i.slice(0,e),o=i.length-1-i.lastIndexOf(s));l=g;c=0;continue}else if(i.length!==0){i='';o=0;l=g;c=0;continue}}r&&(i+=i.length>0?`${s}..`:'..',o=2)}else i.length>0?(i+=`${s}${n.slice(l+1,g)}`):(i=n.slice(l+1,g)),o=g-l-1;l=g;c=0}else u===t&&c!==-1?++c:(c=-1)}return i}function o(n){if(n.length===0)return'.';let t=n.charCodeAt(0)===e,r=n.charCodeAt(n.length-1)===e;n=i(n,!t,'/',s);if(n.length===0){if(t)return'/';return r?'./':'.'}r&&(n+='/');return t?`/${n}`:n}function l(...e){if(e.length===0)return'.';if(e.length===2&&e[1][0]==='/')return o(e[1]);let n;for(let t=0;t<e.length;++t){let r=e[t];r.length>0&&(n===void 0?(n=r):(n+=`/${r}`))}if(n===void 0)return'.';return o(n)}return{join:l,baseName:r}}let{join,baseName}=pathModule();function repl(){let e=65536,n=4*e,t=new TTY(0),r=Buffer.alloc(e);t.setup(r,UV_TTY_MODE_NORMAL);t.onRead(e=>{let s=r.read(0,e);try{let e=runScript(s,'repl');if(e&&e!==void 0){let n=`${JSON.stringify(e,null,2)}\n`,t=a.write(r.write(n,0));if(t<0)return a.close()}}catch(e){print(e.stack)};let i=a.write(r.write('> ',0));if(i<0)return a.close();i<e&&a.queueSize()>=n&&t.pause()});t.onEnd(()=>t.close());t.onClose(()=>a.close());let a=new TTY(1);a.setup(r,UV_TTY_MODE_NORMAL);a.onDrain(()=>t.resume());a.onClose(()=>t.close());a.write(r.write('> ',0))<0?a.close():t.resume()}function readFile(e){let n=4096,t=Buffer.alloc(n),r=new File,a=[];r.setup(t,t);r.fd=r.open(e,O_RDONLY);if(r.fd<0)throw new Error(`Error opening ${e}: ${loop.error(r.fd)}`);r.size=0;let s=r.read(n,r.size);while(s>0)r.size+=s,a.push(t.read(0,s)),s=r.read(n,r.size);if(s<0)throw new Error(`Error reading ${e}: ${loop.error(s)}`);r.close();r.text=a.join('');return r}class Parser{constructor(e,n){this.position=0;this.message={opCode:0,threadId:0,payload:''};this.rb=e;this.wb=n;this.view={recv:new DataView(e.bytes),send:new DataView(n.bytes)};this.onMessage=()=>{}}read(e,n = 0){let{rb:t,view:r,message:a}=this,{position:s}=this,{recv:i}=r;while(n<e){if(s===0)a.threadId=i.getUint8(n++),s++;else if(s===1)a.opCode=i.getUint8(n++),s++;else if(s===2)a.length=i.getUint8(n++)<<8,s++;else if(s===3)a.length+=i.getUint8(n++),s++,a.payload='';else{let r=a.length-(s-4);r+n>e?(r=e-n,a.opCode!==3&&(a.payload+=t.read(n,r)),s+=r,n=e):(a.opCode!==3?(a.payload+=t.read(n,r),this.onMessage(Object.assign({},a))):(a.payload=null,a.offset=n,this.onMessage(Object.assign({},a))),n+=r,s=0)}}this.position=s}write(e,n = 1,t = 0,r = 0){let{wb:a,view:s}=this,{send:i}=s;if(n===1){let r=JSON.stringify(e),s=r.length;i.setUint8(t,process.TID||process.PID);i.setUint8(t+1,n);i.setUint16(t+2,s);a.write(r,t+4);return s+4}else if(n===2){let r=e.length;i.setUint8(t,process.TID||process.PID);i.setUint8(t+1,n);i.setUint16(t+2,r);a.write(e,t+4);return r+4}else if(n===3){i.setUint8(t,process.TID||process.PID);i.setUint8(t+1,n);i.setUint16(t+2,r);return r+4}return 0}}let mem=new Float64Array(16),cpu=new Float64Array(2),time=new BigInt64Array(1),next=1,queue=[],threads={},heap=[new Float64Array(4),new Float64Array(4),new Float64Array(4),new Float64Array(4),new Float64Array(4),new Float64Array(4),new Float64Array(4),new Float64Array(4),new Float64Array(4),new Float64Array(4),new Float64Array(4),new Float64Array(4),new Float64Array(4),new Float64Array(4),new Float64Array(4),new Float64Array(4)];Error.stackTraceLimit=1e3;Error.prepareStackTrace=(e,n)=>{let t=[];for(let e of n){let n=e.getTypeName(),r=e.getFunctionName(),a=e.getMethodName(),s=e.getFileName(),i=e.getLineNumber(),o=e.getColumnNumber(),l=e.isToplevel(),c=e.isEval(),u=!1,g=e.isNative(),p=!0,w=e.isConstructor();t.push({typeName:n,functionName:r,methodName:a,scriptName:s,line:i,column:o,isToplevel:l,isEval:c,isNative:g,isConstructor:w,isWasm:u,isUserJavascript:p})}Object.getOwnPropertyDescriptor(e,'frames')?(e.frames=t):Object.defineProperty(e,'frames',{value:t,writable:!0,enumerable:!0});Object.getOwnPropertyDescriptor(e,'fileName')?(e.fileName=t[0].scriptName):Object.defineProperty(e,'fileName',{value:t[0].scriptName,writable:!0,enumerable:!0});Object.getOwnPropertyDescriptor(e,'lineNumber')?(e.lineNumber=t[0].line):Object.defineProperty(e,'lineNumber',{value:t[0].line,writable:!0,enumerable:!0});Object.getOwnPropertyDescriptor(e,'type')?(e.type='GeneralException'):Object.defineProperty(e,'type',{value:'GeneralException',writable:!0,enumerable:!0});return e.stack};global.onUncaughtException=e=>{Object.defineProperty(e,'type',{value:'UncaughtException',writable:!1,enumerable:!0});let n=e.stack;if(process.onUncaughtException)return process.onUncaughtException(e);print(`${e.type}\n${n}`)};global.onUnhandledRejection=(e,n)=>{Object.defineProperty(e,'type',{value:'UnhandledRejection',writable:!1,enumerable:!0});Object.defineProperty(e,'promise',{value:n,writable:!1,enumerable:!0});let t=e.stack;if(process.onUnhandledRejection)return process.onUnhandledRejection(e);print(`${e.type}\n${t}`)};function setTimeout(e,n){let t=new Timer;t.start(()=>{e(),t.close()},n);return t}function setInterval(e,n){let t=new Timer;t.start(e,n,n);return t}function clearTimeout(e){e.stop();e.close()}let GlobalBuffer=global.Buffer;global.Buffer={alloc:e=>{let n=new GlobalBuffer,t=n.alloc(e);n.size=e;n.bytes=t;return n},fromString:e=>{let n=global.Buffer.alloc(e.length);n.write(e);return n},fromArrayBuffer:e=>{let n=new GlobalBuffer;n.load(e);n.size=e.byteLength;n.bytes=e;return n}};let _process=new Process,process={},loop=new EventLoop;process.loop=loop;process.cwd=(...e)=>_process.cwd.apply(_process,e);process.sleep=(...e)=>_process.sleep.apply(_process,e);process.usleep=(...e)=>_process.usleep.apply(_process,e);process.nanosleep=(...e)=>_process.nanosleep.apply(_process,e);global.__dirname=process.cwd();global.__filename='main.js';process.cpuUsage=()=>{_process.cpuUsage(cpu);return{user:cpu[0],system:cpu[1]}};process.hrtime=()=>{_process.hrtime(time);return time[0]};process.heapUsage=()=>{let e=_process.heapUsage(heap);e.spaces=Object.keys(e.heapSpaces).map(n=>{let t=e.heapSpaces[n];return{name:n,size:t[2],used:t[3],available:t[1],physicalSize:t[0]}});delete e.heapSpaces;return e};process.memoryUsage=()=>{_process.memoryUsage(mem);return{rss:mem[0],total_heap_size:mem[1],used_heap_size:mem[2],external_memory:mem[3],does_zap_garbage:mem[4],heap_size_limit:mem[5],malloced_memory:mem[6],number_of_detached_contexts:mem[7],number_of_native_contexts:mem[8],peak_malloced_memory:mem[9],total_available_size:mem[10],total_heap_size_executable:mem[11],total_physical_size:mem[12],isolate_external:mem[13]}};global.setTimeout=setTimeout;global.setInterval=setInterval;global.clearTimeout=clearTimeout;global.clearInterval=clearTimeout;global.process=process;process.runMicroTasks=(...e)=>_process.runMicroTasks.apply(_process,e);process.ticks=0;let idleActive=!1;process.stats=()=>{let e={ticks:process.ticks,queue:queue.length};return e};let activeHandles=()=>{let e=Buffer.alloc(16384);loop.listHandles(e);let n=new Uint8Array(e.bytes),t=0,r=[];while(1){let a=n[t];if(a===255)break;let s=n[t+1];if(s>0){let n=e.read(t+2,s);r.push({active:a,type:n})}else r.push({active:a,type:'unknown'});t+=2+s}return r};process.activeHandles=activeHandles;let nextTick=e=>{queue.push(e);if(idleActive)return;loop.onIdle(()=>{process.ticks++;let e=queue.length;while(e--){let e=queue.shift();e&&e()}queue.length||(idleActive=!1,loop.onIdle())});loop.ref();idleActive=!0};process.nextTick=nextTick;let runScriptFromFile=e=>{let n=join(global.__dirname,e),{text:t}=readFile(n);global.__dirname=baseName(n);global.__filename=n;return runScript(t,n)},cache={};global.require=(e,n)=>{let t=n?n.dirName:global.__dirname,r=join(t,e);t=baseName(r);let a=cache[r];if(a)return a.exports;let s=['exports','require','module','process'];a={exports:{},dirName:t,fileName:r};a.text=(readFile(r)).text;a.function=compile(a.text,r,s,[]);let i=Object.create(global.process);i.spawn=(e,n,t)=>{t.dirname=a.dirName;return process.spawn(e,n,t)};a.function.call(a.exports,a.exports,e=>global.require(e,a),a,i);cache[r]=a;print(`require: ${e}, fileName: ${r}, dirName: ${t}, size: ${a.text.length}`);return a.exports};function runLoop(){do{loop.run()}while(loop.isAlive());process.onExit&&process.onExit()}process.runLoop=runLoop;process.exec=(...e)=>_process.spawn.apply(_process,e);process.spawn=(e,n,t = {ipc:!1,dirname:global.__dirname})=>{let r=new Thread,a=JSON.stringify(process.env),s=JSON.stringify(process.args);t.dirname=t.dirname||global.__dirname;let i=a.length+s.length+t.dirname.length+17;r.buffer=Buffer.alloc(i);let o=new DataView(r.buffer.bytes);if(t.ipc){let e=parseInt(process.env.THREAD_BUFFER_SIZE||1024,10),[n,t]=[Buffer.alloc(e),Buffer.alloc(e)],a=new Socket(UNIX),s=new Parser(n,t);a.onConnect(()=>{a.setup(n,t),a.resume()});a.onEnd(()=>a.close());a.onRead(e=>s.read(e));s.onMessage=e=>r._onMessage(e);r.onMessage=e=>{r._onMessage=e};r._onMessage=e=>{};r.send=e=>a.write(s.write(e));r.sendString=e=>{a.write(s.write(e,2))};r.sendBuffer=e=>a.write(s.write(null,3,0,e));let i=a.open();if(i<0){throw new Error(`Error: ${i}: ${a.error(i)}`)}o.setUint32(1,i);r.sock=a}else o.setUint32(1,0);r.view=o;r.id=next++;o.setUint8(0,r.id);o.setUint32(5,a.length);r.buffer.write(a,9);o.setUint32(a.length+9,s.length);r.buffer.write(s,a.length+13);o.setUint32(a.length+s.length+13,t.dirname.length);r.buffer.write(t.dirname,a.length+s.length+17);threads[r.id]=r;let l=r.start(e,e=>{delete threads[r.id],n({err:e,thread:r})},r.buffer);l!==0&&n({err:new Error(`Bad Status: ${l} (${loop.error(l)})`,r,0)});return r};global.dv8={repl,readFile,join,baseName,cache};if(global.workerData){global.workerData.bytes=global.workerData.alloc();let e=new DataView(global.workerData.bytes);process.TID=e.getUint8(0);process.PID=_process.pid();process.fd=e.getUint32(1);let n=e.getUint32(5),t=global.workerData.read(9,n);process.env=JSON.parse(t);let r=e.getUint32(9+n),a=global.workerData.read(13+n,r);process.args=JSON.parse(a);let s=e.getUint32(13+n+r);s>0&&(global.__dirname=global.workerData.read(17+n+r,s));if(process.fd!==0){let e=parseInt(process.env.THREAD_BUFFER_SIZE||1024,10),[n,t]=[Buffer.alloc(e),Buffer.alloc(e)],r=new Socket(UNIX),a=new Parser(n,t);r.onConnect(()=>{r.setup(n,t),r.resume()});a.onMessage=e=>r.onMessage(e);process.send=e=>r.write(a.write(e));process.sendString=e=>{r.write(a.write(e,2))};process.sendBuffer=e=>r.write(a.write(null,3,0,e));r.onRead(e=>a.read(e));r.onEnd(()=>r.close());process.onMessage=e=>{r.onMessage=e};r.open(process.fd);process.sock=r}let{workerSource:i,workerName:o}=global;delete global.workerSource;delete global.workerName;delete global.workerData;let l=join(global.__dirname,process.args[1]),c=`${l}.#${process.TID}.${o||'anonymous'}`;runScript(i.slice(i.indexOf('{')+1,i.lastIndexOf('}')),c)}else process.env=ENV,process.PID=_process.pid(),process.TID=0,process.args=global.args,process.threads=threads,process.args.length<2?repl():(process.args[1]==='-e'?runScript(global.args[2],'eval'):runScriptFromFile(process.args[1]));runLoop()
//# sourceMappingURL=main.min.js.map